<template>
  <div>
    <h1>{{ pluginData.name }} Plugin</h1>

    <div class="version-info hint">
      <template v-if="exportPluginVersion">Export plugin version {{ exportPluginVersion }}</template>
      <template v-if="exportPluginVersion && importPluginVersion"> | </template>
      <template v-if="importPluginVersion">Import plugin version {{ importPluginVersion }}</template>
    </div>

    <!-- eslint-disable-next-line vue/no-v-html -->
    <div class="plugin-description" v-html="pluginData.description.join(`\n`)" />

    <ul>
      <li v-for="link in Object.keys(pluginData.links)" :key="link">
        <a :href="pluginData.links[link]" target="_blank" rel="nofollow">{{ link }}</a>
      </li>
    </ul>

    <app-help-wanted-message
      v-if="`helpWanted` in pluginData"
      type="plugin"
      :context="pluginData"
      @help-wanted-clicked="openHelpWantedDialog" />

    <div v-if="`fixtureUsage` in pluginData" class="fixture-usage">
      <h2 id="fixture-usage">Fixture usage</h2>

      <!-- eslint-disable-next-line vue/no-v-html -->
      <div v-html="pluginData.fixtureUsage.join(`\n`)" />
    </div>

    <div v-if="`fileLocations` in pluginData" class="file-locations">
      <h2>File locations</h2>

      <p v-if="`subDirectoriesAllowed` in pluginData.fileLocations">
        Fixture files in subdirectories are {{ pluginData.fileLocations.subDirectoriesAllowed ? `recognized` : `not recognized` }}.
      </p>

      <div v-for="os in fileLocationOSes" :key="os">
        <h3>{{ os }}</h3>

        <section>
          <div v-for="library in Object.keys(pluginData.fileLocations[os])" :key="`${os}-${library}`">
            {{ libraryNames[library] }}: <code>{{ pluginData.fileLocations[os][library] }}</code>
          </div>
        </section>
      </div>
    </div>

    <div v-if="`additionalInfo` in pluginData" class="additional-info">
      <h2>Additional information</h2>

      <!-- eslint-disable-next-line vue/no-v-html -->
      <div v-html="pluginData.additionalInfo.join(`\n`)" />
    </div>

    <p style="margin-top: 3rem;"><nuxt-link to="/about/plugins">Back to plugin overview</nuxt-link></p>

    <app-help-wanted-dialog v-model="helpWantedContext" type="plugin" />
  </div>
</template>

<style lang="scss" scoped>
.version-info {
  margin: -1rem 0 0;
}

.plugin-description,
.fixture-usage,
.file-locations,
.additional-info {
  & /deep/ h2,
  & /deep/ h3 {
    margin: 1.5rem 0 -0.5rem;
    line-height: 1.3;
  }

  & /deep/ p {
    text-align: justify;
  }

  & /deep/ code {
    background-color: $grey-50;
    padding: 3px 5px;
  }

  & /deep/ table {
    margin: 1rem 0;
    border: 1px solid $divider-dark;
    border-collapse: collapse;

    th, td {
      border: 1px solid $divider-dark;
      padding: 1px 1ex;
    }
  }
}

</style>

<script>
import plugins from '~~/plugins/plugins.json';

import helpWantedDialog from '~/components/help-wanted-dialog.vue';
import helpWantedMessage from '~/components/help-wanted-message.vue';

export default {
  components: {
    'app-help-wanted-dialog': helpWantedDialog,
    'app-help-wanted-message': helpWantedMessage
  },
  validate({ params }) {
    return decodeURIComponent(params.plugin) in plugins.data;
  },
  async asyncData({ params, query, app, redirect }) {
    const pluginKey = decodeURIComponent(params.plugin);

    if (plugins.data[pluginKey].outdated) {
      redirect(301, `/about/plugins/${plugins.data[pluginKey].newPlugin}`);
      return {};
    }

    const pluginData = await app.$axios.$get(`/about/plugins/${pluginKey}.json`);
    pluginData.key = pluginKey;

    const fileLocationOSes = `fileLocations` in pluginData ? Object.keys(pluginData.fileLocations).filter(
      os => os !== `subDirectoriesAllowed`
    ) : null;

    return {
      pluginData,
      fileLocationOSes,
      exportPluginVersion: plugins.data[pluginKey].exportPluginVersion,
      importPluginVersion: plugins.data[pluginKey].importPluginVersion,
      libraryNames: {
        main: `Main (system) library`,
        user: `User library`
      }
    };
  },
  data() {
    return {
      helpWantedContext: null
    };
  },
  head() {
    const title = `${this.pluginData.name} Plugin`;

    return {
      title,
      meta: [
        {
          hid: `title`,
          content: title
        }
      ]
    };
  },
  methods: {
    openHelpWantedDialog(event) {
      this.helpWantedContext = event.context;
    }
  }
};
</script>
